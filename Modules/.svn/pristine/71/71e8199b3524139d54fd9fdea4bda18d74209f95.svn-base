/*
  BB1 G Truslove - Nov 2017
  Knowledge Base Articles
*/

define('Article.Model', [
    'SC.Model'
  ],
  function(SCModel) {
    return SCModel.extend({
      name: 'Article',
      get: function(url, language) {
        nlapiLogExecution("ERROR", "SCA Testing", "Language=" + language);
        var filters = [],
          columns = [];

        filters.push(['isinactive', 'is', 'F']);
        filters.push('AND');
        filters.push(['custrecord_bb1_sca_a_url', 'is', url]);
        filters.push('AND');
        filters.push(['custrecord_bb1_sca_a_language', 'anyof', language.toString()]);


        columns.push(new nlobjSearchColumn('name'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_type'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_summary'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_keywords'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_content'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_image'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_url'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_language'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_priority'));
        //columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_showonhomepage'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_colour'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_relateditems'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_relatedarticles'));


        var searchresults = nlapiSearchRecord('customrecord_bb1_sca_article', null, filters, columns);

        var res;
        var Info = {};
        for (var i in searchresults) {
          res = searchresults[i];
          Info = {
            internalid: res.getId(),
            name: res.getValue("name"),
            type: res.getValue("custrecord_bb1_sca_a_type"),
            summary: res.getValue("custrecord_bb1_sca_a_summary"),
            keywords: res.getValue("custrecord_bb1_sca_a_keywords"),
            content: res.getValue("custrecord_bb1_sca_a_content"),
            image: res.getText("custrecord_bb1_sca_a_image"),
            url: res.getValue("custrecord_bb1_sca_a_url"),
            language: res.getValue("custrecord_bb1_sca_a_language"),
            priority: res.getValue("custrecord_bb1_sca_a_priority"),
            colour: res.getValue("custrecord_bb1_sca_a_colour"),
            relateditems: res.getValue("custrecord_bb1_sca_a_relateditems"),
            relatedarticles: this.getRelatedArticles(res.getValue("custrecord_bb1_sca_a_relatedarticles"), language)
          };
          break;
        }
        return Info;
      },
      getRelatedArticles: function(articles, language) { //Get related article links
        if (!articles || articles.length == 0) {
          return [];
        }
        var filters = [],
          columns = [];


        filters.push(['isinactive', 'is', 'F']);
        filters.push('AND');
        filters.push(['internalid', 'anyof', articles.split(',')]);
        filters.push('AND');
        filters.push(['custrecord_bb1_sca_a_language', 'anyof', language.toString()]);
        filters.push('AND');
        filters.push(['custrecord_bb1_sca_a_approved', 'is', 'T']);


        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_url'));
        columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_type'));

        var SC = new nlobjSearchColumn('name');
        SC.setSort(false);
        columns.push(SC);

        var searchresults = nlapiSearchRecord('customrecord_bb1_sca_article', null, filters, columns);

        var res;
        var List = [];
        for (var i in searchresults) {
          res = searchresults[i];
          List.push({
            internalid: res.getId(),
            name: res.getValue("name"),
            type: res.getValue("custrecord_bb1_sca_a_type"),
            url: res.getValue("custrecord_bb1_sca_a_url"),
          });

        }

        return List;
      },
      list: function(Type, language, showonhomepage) {

        try {
          var filters = [],
            columns = [];


          filters.push(['isinactive', 'is', 'F']);
          filters.push('AND');
          filters.push(['custrecord_bb1_sca_a_language', 'anyof', language.toString()]);
          filters.push('AND');
          filters.push(['custrecord_bb1_sca_a_approved', 'is', 'T']);
          var isType = Type && Type.length > 0;
          if (Type && Type.length > 1) {
            filters.push('AND');
            filters.push(['custrecord_bb1_sca_a_type', 'anyof', Type]);
            filters.push('AND');
            filters.push(['custrecord_bb1_sca_a_priority', 'anyof', [1, 2, 3, 4]]);
          } else if(Type && Type.length == 1) {
            filters.push('AND');
            filters.push(['custrecord_bb1_sca_a_type', 'anyof', Type]);
            filters.push('AND');
            filters.push(['custrecord_bb1_sca_a_priority', 'anyof', [1, 2, 3]]);
          }
          if (showonhomepage) {
            filters.push('AND');
            filters.push(['custrecord_bb1_sca_a_showonhomepage', 'is', 'T']);
          }
          columns.push(new nlobjSearchColumn('name'));
          columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_image'));
          columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_url'));
          columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_colour'));
          //columns.push(new nlobjSearchColumn('custrecord_bb1_sca_a_order'));

          var SC = new nlobjSearchColumn('custrecord_bb1_sca_a_priority');
          SC.setSort(false);
          columns.push(SC);

          SC = new nlobjSearchColumn('custrecord_bb1_sca_a_type');
          SC.setSort(false);
          columns.push(SC);

          

          var searchresults = nlapiSearchRecord('customrecord_bb1_sca_article', null, filters, columns);

          var res;
          var List = [];
          var lasttype, newtype, lastpriority, newpriority,imageleft=true;
          for (var i in searchresults) {
            res = searchresults[i];
            newtype = res.getValue("custrecord_bb1_sca_a_type");
            if (List.length > 0 && newtype != lasttype && !isType) { //Nesting views in backbone seems to be too much hassle, so just adding a endoftype check.
              List.push({ type: lasttype, endoftype: true });
            }
            newpriority = res.getValue("custrecord_bb1_sca_a_priority");
            if(newpriority != lastpriority){
            imageleft=true;
            }
            List.push({
              internalid: res.getId(),
              name: res.getValue("name"),
              type: newtype,
              image: res.getText("custrecord_bb1_sca_a_image"),
              url: res.getValue("custrecord_bb1_sca_a_url"),
              priority: newpriority,
              colour: res.getValue("custrecord_bb1_sca_a_colour"),
              firsttype: !isType && newtype != lasttype,
              firstpriority: newpriority != lastpriority,
              imageleft:imageleft
            });

            lasttype = newtype;
            lastpriority = newpriority;
            imageleft=!imageleft;
          }
          if (List.length > 0 && !isType) { //Nesting views in backbone seems to be too much hassle, so just adding a endoftype check.
            List.push({ type: lasttype, endoftype: true });
          }
          //nlapiLogExecution("ERROR", "SCA Article Main", JSON.stringify(List));
          return List;
        } catch (err) {
          nlapiLogExecution("ERROR", "SCA Article Main Error", err.toString());
          return []
        }
      }
    });
  })