define('ContactUsTest.View'
, [
    'Backbone'
  , 'Backbone.FormView'
  , 'contact_us_test.tpl'
  , 'jQuery'
  , 'underscore'
  , 'GlobalViews.Message.View'
  ]
, function
  (
    Backbone
  , BackboneFormView
  , contactUsTestTpl
  , jQuery
  , _
  , MessageView
  )
{
  'use strict';

  return Backbone.View.extend({

    title: _('Contact Us Test').translate(),

    attributes:
    {
      'class': 'contactustest'
    },

    events: {
      'submit form': 'saveTheForm'
    },

    bindings:
    {
      '[name="firstname"]': 'firstname'
    , '[name="lastname"]': 'lastname'
    , '[name="email"]': 'email'
    , '[name="title"]': 'title'
    , '[name="incomingmessage"]': 'incomingmessage'
    },

    getBreadcrumbPages: function()
    {
      return [{
        text: _('Contact Us Test').translate()
      , href: '/contact-us-test'
      }]
    },

    initialize: function(options){
      this.options = options,
      this.application = options.application

      BackboneFormView.add(this);
    },
    
    saveTheForm: function(e)
    {
      var self = this;
      var promise = BackboneFormView.saveForm.apply(this, arguments);
  
      e.preventDefault();
  
      return promise && promise.then
      (
        function(success)
        {
          if (success.successMessage)
          {
            self.showMessage(success.successMessage, 'success');
          }
          else {
            self.showMessage('An error occured, please try again', 'error')
          }
        }
      , function(fail)
        {
          fail.preventDefault = true;
  
          _.each(fail.responseJSON.errorMessage, function(message, field)
          {
            self.showMessage(message, 'error', field);
          });
        }
      );
    },

    showMessage: function(message, type, field)
    {
      var messageView = new MessageView
      ({
        message: message
      , type: type
      });
  
      if (typeof field !== 'undefined')
      {
        this.application.getLayout().$('[data-input="' + field + '"]').append(messageView.render().$el);
      }
      else
      {
        this.application.getLayout().$('form').append(messageView.render().$el);
      }
    },

    template: contactUsTestTpl

  });
});